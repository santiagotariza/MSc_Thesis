---
title: "Design and Implementation of a Bioinformatic Pipeline for the Identification of Long Noncoding
RNAs with Antigenic Potential in Ovarian Cancer"
author: "Santiago T. Ariza"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
    theme: cosmo
    highlight: tango
    toc_float: true
---

```{r setup, include=FALSE}
# Global chunk options
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align = 'center', fig.width = 8, fig.height = 7)

# Define the path to the results folder (relative to 'scripts')
results_dir <- "../results"

# Load all required libraries at the beginning
library(knitr)
library(tidyverse)
library(dplyr)
library(DT)
library(htmltools)
library(stringr)
```

# Abstract

This report details a comprehensive RNA-Seq analysis performed on HOSEPIC cell samples. The goal was to study the impact of HMGB1 and HMGB2 gene knockouts, specifically by examining changes in gene expression after treatment with extracellular vesicles. The bioinformatics workflow included several key steps: raw data quality control, alignment, and gene quantification.

Following these initial steps, a series of exploratory and statistical analyses were conducted in R to identify and characterize differentially expressed genes (DEGs) and long non-coding RNAs (lncRNAs), and to understand their associated biological functions.

# Raw Data Quality Control and Pre-processing

The first crucial step in any RNA-Seq analysis is to evaluate the quality of the raw sequencing data. This ensures that only high-quality reads are used for downstream analyses, minimizing technical noise and potential biases. This section presents key metrics to assess the quality of the raw FASTQ sequences and the resulting gene counts.

## fastp Quality Metrics

The fastp tool was used to perform quality filtering and adapter trimming. The plots below summarize critical metrics such as the percentage of bases with a quality score of Q20 and Q30, providing a clear picture of the sequencing quality both before and after processing. These metrics are a good indicator of the overall quality and reliability of the sequencing data.

```{r}
# Load the plot generated by the 02_exploratory_qc_analysis.R script
fastp_plot_path <- file.path(results_dir, "02_fastp_quality_metrics.png")
if (file.exists(fastp_plot_path)) {
  knitr::include_graphics(fastp_plot_path)
} else {
  cat("The fastp quality metrics plot was not found in the results directory. Please ensure that the '02_exploratory_qc_analysis.R' script has been run correctly.")
}
```

## Raw Count Distribution

Analyzing the distribution of raw gene counts is an essential step to check for consistency across samples and to detect potential outliers before normalization. The histograms below illustrate the count distribution for both mRNA and lncRNA transcripts.

### mRNA Raw Counts Distribution

```{r}
raw_counts_plot_mRNA_path <- file.path(results_dir, "02_mRNA_raw_counts_distribution.png")
if (file.exists(raw_counts_plot_mRNA_path)) {
  knitr::include_graphics(raw_counts_plot_mRNA_path)
} else {
  cat("The mRNA raw counts distribution plot was not found. Please run '02_exploratory_qc_analysis.R'.")
}
```

### lncRNA Raw Counts Distribution

```{r}
raw_counts_plot_lncRNA_path <- file.path(results_dir, "02_lncRNA_raw_counts_distribution.png")
if (file.exists(raw_counts_plot_lncRNA_path)) {
  knitr::include_graphics(raw_counts_plot_lncRNA_path)
} else {
  cat("The lncRNA raw counts distribution plot was not found. Please run '02_exploratory_qc_analysis.R'.")
}
```

## Raw Counts Correlation Heatmaps

Correlation heatmaps provide a visual overview of the similarity between samples based on their raw gene expression patterns. Samples that are biologically similar (e.g., replicates from the same condition) are expected to have a high correlation.

### mRNA Correlation Heatmap

```{r}
correlation_heatmap_mRNA_path <- file.path(results_dir, "02_mRNA_correlation_heatmap.png")
if (file.exists(correlation_heatmap_mRNA_path)) {
  knitr::include_graphics(correlation_heatmap_mRNA_path)
} else {
  cat("The mRNA correlation heatmap was not found. Please run '02_exploratory_qc_analysis.R'.")
}
```

### lncRNA Correlation Heatmap

```{r}
correlation_heatmap_lncRNA_path <- file.path(results_dir, "02_lncRNA_correlation_heatmap.png")
if (file.exists(correlation_heatmap_lncRNA_path)) {
  knitr::include_graphics(correlation_heatmap_lncRNA_path)
} else {
  cat("The lncRNA correlation heatmap was not found. Please run '02_exploratory_qc_analysis.R'.")
}
```

# Exploratory Data Analysis (EDA)

This section focuses on visualizing the relationships between samples and identifying potential batch effects, which are technical variations that can obscure true biological signals. We use Principal Component Analysis (PCA) and heatmaps to explore these relationships before and after batch effect correction.

## PCA and Heatmap (without Batch Correction)

Principal Component Analysis (PCA) is a dimensionality reduction technique that helps visualize the overall expression patterns. Samples that cluster together on a PCA plot share similar gene expression profiles. The heatmap provides a more detailed view of the correlation between samples.

### mRNA PCA

```{r}
pca_unfiltered_mrna_path <- file.path(results_dir, "04_mRNA_pca_vsd.png")
if (file.exists(pca_unfiltered_mrna_path)) {
  knitr::include_graphics(pca_unfiltered_mrna_path)
} else {
  cat("The uncorrected mRNA PCA plot was not found. Please run '04_exploratory_plots.R'.")
}
```

### mRNA Heatmap

```{r}
heatmap_unfiltered_mrna_path <- file.path(results_dir, "04_mRNA_heatmap_top_var_genes_vsd.png")
if (file.exists(heatmap_unfiltered_mrna_path)) {
  knitr::include_graphics(heatmap_unfiltered_mrna_path)
} else {
  cat("The uncorrected mRNA heatmap was not found. Please run '04_exploratory_plots.R'.")
}
```

## Correcting for Batch Effects with ComBat

The PCA results above revealed a clear batch effect, which could be a source of technical variation that masks the biological differences we're interested in. The ComBat algorithm was used to adjust the data and remove this unwanted technical variability, allowing us to focus on the true biological signals.

### mRNA PCA with ComBat

```{r}
pca_combat_mrna_path <- file.path(results_dir, "05_mRNA_pca_combat_corrected.png")
if (file.exists(pca_combat_mrna_path)) {
  knitr::include_graphics(pca_combat_mrna_path)
} else {
  cat("The ComBat-corrected mRNA PCA plot was not found. Please run '05_correct_batch_effect.R'.")
}
```

### mRNA Heatmap with ComBat

```{r}
heatmap_combat_mrna_path <- file.path(results_dir, "05_mRNA_heatmap_combat_corrected.png")
if (file.exists(heatmap_combat_mrna_path)) {
  knitr::include_graphics(heatmap_combat_mrna_path)
} else {
  cat("The ComBat-corrected mRNA heatmap was not found. Please run '05_correct_batch_effect.R'.")
}
```

## lncRNA Exploratory Analysis

The same exploratory analyses were performed for the long non-coding RNA (lncRNA) data to ensure data quality and assess the need for batch effect correction.

### lncRNA PCA and Heatmap (without Correction)

lncRNA PCA

```{r}
pca_unfiltered_lncrna_path <- file.path(results_dir, "04_lncRNA_pca_vsd.png")
if (file.exists(pca_unfiltered_lncrna_path)) {
  knitr::include_graphics(pca_unfiltered_lncrna_path)
} else {
  cat("The uncorrected lncRNA PCA plot was not found. Please run '04_exploratory_plots.R'.")
}
```

lncRNA Heatmap

```{r}
heatmap_unfiltered_lncrna_path <- file.path(results_dir, "04_lncRNA_heatmap_top_var_genes_vsd.png")
if (file.exists(heatmap_unfiltered_lncrna_path)) {
  knitr::include_graphics(heatmap_unfiltered_lncrna_path)
} else {
  cat("The uncorrected lncRNA heatmap was not found. Please run '04_exploratory_plots.R'.")
}
```

### lncRNA Batch Correction with ComBat

lncRNA PCA with ComBat

```{r}
pca_combat_lncrna_path <- file.path(results_dir, "05_lncRNA_pca_combat_corrected.png")
if (file.exists(pca_combat_lncrna_path)) {
  knitr::include_graphics(pca_combat_lncrna_path)
} else {
  cat("The ComBat-corrected lncRNA PCA plot was not found. Please run '05_correct_batch_effect.R'.")
}
```

lncRNA Heatmap with ComBat

```{r}
heatmap_combat_lncrna_path <- file.path(results_dir, "05_lncRNA_heatmap_combat_corrected.png")
if (file.exists(heatmap_combat_lncrna_path)) {
  knitr::include_graphics(heatmap_combat_lncrna_path)
} else {
  cat("The ComBat-corrected lncRNA heatmap was not found. Please run '05_correct_batch_effect.R'.")
}
```

# Differential Expression (DE) Analysis

The DESeq2 package was used to perform the differential expression analysis. This robust statistical method is specifically designed for RNA-Seq count data to identify genes and lncRNAs that show significant changes in expression between different experimental conditions. The results are visualized using Volcano Plots, which highlight genes with both a large magnitude of change (log2FoldChange) and high statistical significance (-log10(p-value)).

## Differential Expression of mRNA

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# Load dds objects to get the total number of analyzed genes.
load(file.path(results_dir, "03_dds_vsd_objects.RData"))
total_genes_mRNA <- nrow(mRNA_obj$dds)

# Define the comparisons for the mRNA plots
mRNA_comparisons <- list(
  "G3_HMGB1_KO_vs_G1_NTC",
  "G4_HMGB2_KO_vs_G1_NTC",
  "G2_WTC_vs_G1_NTC",
  "G3_HMGB1_KO_vs_G4_HMGB2_KO",
  "G3_HMGB1_KO_vs_G2_WTC",
  "G4_HMGB2_KO_vs_G2_WTC"
)

# Loop to include each Volcano Plot
for (comp in mRNA_comparisons) {
  volcano_plot_path <- file.path(results_dir, paste0("06_mRNA_", comp, "_volcano_plot.png"))
  results_csv_path <- file.path(results_dir, paste0("06_mRNA_", comp, "_DE_results.csv"))
  
  if (file.exists(volcano_plot_path) && file.exists(results_csv_path)) {
    # Load DE results to count the genes
    de_results <- read.csv(results_csv_path, stringsAsFactors = FALSE)
    num_genes_sig <- nrow(de_results)
    
    # Count upregulated and downregulated genes
    num_upregulated <- sum(de_results$log2FoldChange > 0, na.rm = TRUE)
    num_downregulated <- sum(de_results$log2FoldChange < 0, na.rm = TRUE)
    
    # Build the title and summary in a single string
    markdown_output <- paste0(
      "### Volcano Plot: mRNA ", comp, "\n\n",
      "**Analysis Summary:**\n\n",
      "- **Total genes analyzed:** ", total_genes_mRNA, "\n",
      "- **Significant genes:** ", num_genes_sig, "\n",
      "- **Upregulated genes:** ", num_upregulated, "\n",
      "- **Downregulated genes:** ", num_downregulated, "\n\n",
      "![Volcano Plot for mRNA ", comp, "](", volcano_plot_path, ")\n\n"
    )
    
    # Print the complete Markdown string
    cat(markdown_output)
  } else {
    cat(paste0("The plot or results file for '", comp, "' was not found.\n\n"))
  }
}
```

## Differential Expression of lncRNA

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# Load dds objects to get the total number of analyzed lncRNAs.
#load(file.path(results_dir, "03_dds_vsd_objects.RData"))
total_lncRNAs <- nrow(lncRNA_obj$dds)

# Define the comparisons for the lncRNA plots
lncRNA_comparisons <- list(
  "G3_HMGB1_KO_vs_G1_NTC",
  "G4_HMGB2_KO_vs_G1_NTC",
  "G2_WTC_vs_G1_NTC",
  "G3_HMGB1_KO_vs_G4_HMGB2_KO",
  "G3_HMGB1_KO_vs_G2_WTC",
  "G4_HMGB2_KO_vs_G2_WTC"
)

# Loop to include each Volcano Plot
for (comp in lncRNA_comparisons) {
  volcano_plot_path <- file.path(results_dir, paste0("06_lncRNA_", comp, "_volcano_plot.png"))
  results_csv_path <- file.path(results_dir, paste0("06_lncRNA_", comp, "_DE_results.csv"))
  
  if (file.exists(volcano_plot_path) && file.exists(results_csv_path)) {
    # Load DE results to count the lncRNAs
    de_results <- read.csv(results_csv_path, stringsAsFactors = FALSE)
    num_lncRNAs_sig <- nrow(de_results)
    
    # Count upregulated and downregulated lncRNAs
    num_upregulated <- sum(de_results$log2FoldChange > 0, na.rm = TRUE)
    num_downregulated <- sum(de_results$log2FoldChange < 0, na.rm = TRUE)
    
    # Build the title and summary in a single string
    markdown_output <- paste0(
      "### Volcano Plot: lncRNA ", comp, "\n\n",
      "**Analysis Summary:**\n\n",
      "- **Total lncRNAs analyzed:** ", total_lncRNAs, "\n",
      "- **Significant lncRNAs:** ", num_lncRNAs_sig, "\n",
      "- **Upregulated lncRNAs:** ", num_upregulated, "\n",
      "- **Downregulated lncRNAs:** ", num_downregulated, "\n\n",
      "![Volcano Plot for lncRNA ", comp, "](", volcano_plot_path, ")\n\n"
    )
    
    # Print the complete Markdown string
    cat(markdown_output)
  } else {
    cat(paste0("The plot or results file for '", comp, "' was not found.\n\n"))
  }
}
```

# Enrichment Analysis

Once differentially expressed genes (DEGs) are identified, enrichment analysis helps us understand their underlying biological functions. This analysis determines whether certain predefined sets of genes (e.g., those associated with a specific pathway) are over-represented within our list of DEGs.

## Over-Representation Analysis (ORA)

Over-Representation Analysis (ORA) was performed on the differentially expressed mRNA genes using Gene Ontology (GO) terms and Reactome pathways. The results, shown in the dotplots below, highlight the most significant biological processes and pathways that are affected by the gene knockouts.

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# library(knitr)
# library(stringr)

# Define the comparisons of interest
comparisons <- c(
    "G3_HMGB1_KO_vs_G1_NTC",
    "G4_HMGB2_KO_vs_G1_NTC",
    "G2_WTC_vs_G1_NTC"
)

# Define the analyses and plot types
analyses <- c("GO", "Reactome")

for (comp in comparisons) {
  cat("### Comparison:", comp, "\n\n")
  
  for (analys in analyses) {
    # Build the path to the PNG file
    img_path <- file.path(results_dir, paste0("07_mRNA_ORA_", analys, "_dotplot_", comp, ".png"))
    
    # Check if the file exists before including it
    if (file.exists(img_path)) {
      cat("#### ORA", analys, "Dotplot\n\n")
      cat("![](", img_path, ")\n\n")
    } else {
      cat(paste("No plot file found for ORA", analys, "in", comp, "\n\n"))
    }
  }
  cat("\n---\n\n")
}
```

## Gene Set Enrichment Analysis (GSEA)

Gene Set Enrichment Analysis (GSEA) is a more sensitive approach that assesses whether a gene set is enriched at the top or bottom of a ranked list of all genes, regardless of whether they are individually significant. This method can detect subtle but coordinated changes in expression that ORA might miss. The dotplots and gseaplot2 graphs below visualize the results for GO and Reactome gene sets.

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# library(knitr)
# library(stringr)

# Define the comparisons of interest
comparisons <- c(
    "G3_HMGB1_KO_vs_G1_NTC",
    "G4_HMGB2_KO_vs_G1_NTC",
    "G2_WTC_vs_G1_NTC"
)

# Define the analyses and plot types
gsea_analyses <- c("GO", "Reactome")

for (comp in comparisons) {
  cat("### Comparison:", comp, "\n\n")
  
  # Include the GSEA dotplot for GO
  go_dotplot_path <- file.path(results_dir, paste0("08_mRNA_GSEA_GO_dotplot_", comp, ".png"))
  if (file.exists(go_dotplot_path)) {
    cat("#### GSEA GO Dotplot\n\n")
    cat("![](", go_dotplot_path, ")\n\n")
  }

  # Include the GSEA dotplot for Reactome
  reactome_dotplot_path <- file.path(results_dir, paste0("08_mRNA_GSEA_Reactome_dotplot_", comp, ".png"))
  if (file.exists(reactome_dotplot_path)) {
    cat("#### GSEA Reactome Dotplot\n\n")
    cat("![](", reactome_dotplot_path, ")\n\n")
  }
  
  # Include the gseaplot2, which is specific to GO
  gseaplot2_path <- file.path(results_dir, paste0("08_mRNA_GSEA_gseaplot2_", comp, ".png"))
  if (file.exists(gseaplot2_path)) {
    cat("#### Detailed GSEA Plot\n\n")
    cat("![](", gseaplot2_path, ")\n\n")
  }
  
  cat("\n---\n\n")
}
```

# Candidate lncRNA Characterization

This section focuses on characterizing the differentially expressed lncRNAs, specifically by identifying any associated protein-coding potential and co-expression relationships.

## Co-expressed Pathways Summary

We performed an ORA on protein-coding genes that were found to be co-expressed with our candidate lncRNAs. The table below summarizes the most significant Gene Ontology (GO) terms identified from this analysis, providing insights into the potential biological functions of these lncRNAs.


```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# library(tidyverse)
# library(knitr)
# library(DT)

# results_dir <- normalizePath("../results", mustWork = FALSE)
consolidated_path <- file.path(results_dir, "10_consolidated_coexpression_ORA_results.csv")

if (file.exists(consolidated_path)) {
  coexp_results <- read_csv(consolidated_path, show_col_types = FALSE) %>%
    arrange(comparison, lncRNA_id, p.adjust)

  datatable(coexp_results, 
            options = list(pageLength = 5, searching = TRUE), 
            caption = "Significant GO terms in genes co-expressed with candidate lncRNAs")
} else {
  cat("The consolidated results file was not found.")
}
```

## Putative Open Reading Frames (ORFs) in lncRNAs

A key question for any lncRNA is whether it has any protein-coding potential. We predicted Open Reading Frames (ORFs) using the lncRNA sequences. The table below summarizes these findings, showing the number of ORFs and the length of the longest one found for each lncRNA.


```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# library(tidyverse)
# library(DT)

# Define the results directory (if not in a previous chunk)
# results_dir <- normalizePath("../results", mustWork = FALSE)
orf_summary_path <- file.path(results_dir, "11_predicted_lncRNA_ORFs.csv")

if (file.exists(orf_summary_path)) {
  orf_data <- read_csv(orf_summary_path, show_col_types = FALSE)
  
  orf_summary <- orf_data %>%
    group_by(lncRNA_id) %>%
    summarise(
      total_orfs = n(),
      longest_orf_aa = max(length_aa, na.rm = TRUE),
      .groups = 'drop'
    ) %>%
    arrange(desc(longest_orf_aa))
    
  datatable(orf_summary, 
            options = list(pageLength = 5, searching = TRUE), 
            caption = "Putative ORFs in candidate lncRNAs")
} else {
  cat("The ORFs results file was not found. Please ensure script 11 has been executed.")
}
```

## Prioritized lncRNA Candidates with Putative ORFs

This section highlights the most promising lncRNAs that contain putative open reading frames (ORFs) and show enrichment in relevant pathways.  
For each candidate, we provide a concise summary of its main characteristics (number and size of ORFs, genomic span, and most significant pathway), with the option to expand and view the full table of ORFs if desired.  
Associated enrichment plots are also included to further illustrate potential functional roles.

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

candidates_path <- "../results/13_top_lncRNA_candidates.csv"
results_dir <- "../results"

if (file.exists(candidates_path)) {
  top_candidates_df <- readr::read_csv(candidates_path, show_col_types = FALSE)
  unique_lncRNAs <- unique(top_candidates_df$lncRNA_id)

  all_content <- list()  # Store all content by lncRNA

  for (lncRNA_id in unique_lncRNAs) {
    lncRNA_data <- top_candidates_df %>%
      dplyr::filter(lncRNA_id == !!lncRNA_id) %>%
      dplyr::select(comparison, Description, p.adjust, Count, length_aa, start, end, length_nt, n_ORFs)
    
    first_row <- lncRNA_data[1, ]
    
    # Title
    title_html <- htmltools::HTML(paste0(
      "<h3>Candidate: ", lncRNA_id, "</h3>"
    ))

    # Summary (bullets)
    summary_html <- htmltools::tags$ul(
      htmltools::tags$li(paste("Detected in comparison:", first_row$comparison)),
      htmltools::tags$li(paste("Number of ORFs:", max(lncRNA_data$n_ORFs))),
      htmltools::tags$li(paste("ORF length range:", min(lncRNA_data$length_aa), "–", max(lncRNA_data$length_aa), "aa")),
      htmltools::tags$li(
        paste("Genomic span of the longest ORF: nucleotides", 
              min(lncRNA_data$start), "–", max(lncRNA_data$end),
              "(total length:", max(lncRNA_data$length_nt), "nt)")
      ),
      htmltools::tags$li(
        paste("Most significant pathway:", 
              lncRNA_data$Description[which.min(lncRNA_data$p.adjust)], 
              "(p.adjust =", signif(min(lncRNA_data$p.adjust), 3), ")")
      )
    )

    # Table (hidden by default, expandable with button + custom style)
    tbl <- DT::datatable(
      lncRNA_data,
      options = list(pageLength = 5, searching = FALSE),
      caption = paste("Details for", lncRNA_id)
    )
    table_html <- htmltools::HTML(paste0(
      "<details style='margin-top:10px; margin-bottom:10px; padding:10px; background-color:#f9f9f9; border:1px solid #ddd; border-radius:8px;'>",
      "<summary style='cursor:pointer; font-weight:bold;'>Show detailed ORF table</summary>",
      htmltools::as.tags(tbl),
      "</details>"
    ))

    # Plots
    dotplot_file <- file.path(results_dir, paste0("13_final_candidates_dotplot_", lncRNA_id, ".png"))
    
    if (file.exists(dotplot_file)) {
      graphs_html <- htmltools::tags$div(
        style = "margin-top: 10px; margin-bottom: 20px;",
        htmltools::tags$img(src = dotplot_file, width = "800px", style = "display:block; margin-bottom: 10px;")
      )
    } else {
      graphs_html <- htmltools::HTML("<p><em>No plot found for this lncRNA.</em></p>")
    }

    # Combine all content and store
    all_content[[lncRNA_id]] <- htmltools::tagList(
      title_html,
      summary_html,
      table_html,
      graphs_html,
      htmltools::tags$hr()
    )
  }

  # Display everything
  htmltools::browsable(htmltools::tagList(all_content))

} else {
  cat("<p>The top candidates file was not found. Please make sure script 13 has been run.</p>")
}
```

